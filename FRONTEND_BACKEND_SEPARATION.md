# üîÄ Separa√ß√£o Frontend/Backend - Guia para Trabalho Paralelo

## üéØ Objetivo Deste Documento

Este documento explica como **dividir o trabalho** entre diferentes desenvolvedores ou agentes de IA, permitindo que m√∫ltiplas pessoas trabalhem simultaneamente no projeto sem conflitos.

**Cen√°rios de uso:**
- Voc√™ quer um dev focado em UI e outro em l√≥gica
- Voc√™ quer usar m√∫ltiplos agentes de IA trabalhando em paralelo
- Voc√™ quer aprender frontend sem mexer no backend
- Voc√™ quer trocar o backend sem quebrar o frontend

---

## üìä Diagrama de Separa√ß√£o

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                     PROJETO COMPLETO                         ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                ‚îÇ                       ‚îÇ
        ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê      ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
        ‚îÇ   FRONTEND     ‚îÇ      ‚îÇ   BACKEND   ‚îÇ
        ‚îÇ   (Visual)     ‚îÇ‚óÑ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∫‚îÇ   (L√≥gica)  ‚îÇ
        ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò      ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                ‚îÇ                       ‚îÇ
        ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê      ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
        ‚îÇ  React + Vite  ‚îÇ      ‚îÇ  Supabase   ‚îÇ
        ‚îÇ  Tailwind CSS  ‚îÇ      ‚îÇ  Functions  ‚îÇ
        ‚îÇ  TypeScript    ‚îÇ      ‚îÇ  PostgreSQL ‚îÇ
        ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò      ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                ‚îÇ                       ‚îÇ
        ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê      ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
        ‚îÇ  Respons√°vel   ‚îÇ      ‚îÇ  Respons√°vel‚îÇ
        ‚îÇ  pela UI/UX    ‚îÇ      ‚îÇ  por APIs   ‚îÇ
        ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò      ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## üé® Frontend (Interface Visual)

### üìÅ Arquivos de Responsabilidade

```
‚úÖ PODE EDITAR LIVREMENTE:
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ pages/              # P√°ginas e layouts
‚îÇ   ‚îú‚îÄ‚îÄ components/         # Componentes visuais
‚îÇ   ‚îú‚îÄ‚îÄ lib/utils.ts        # Fun√ß√µes helper do frontend
‚îÇ   ‚îú‚îÄ‚îÄ hooks/              # Custom React hooks
‚îÇ   ‚îú‚îÄ‚îÄ App.tsx             # Rotas
‚îÇ   ‚îú‚îÄ‚îÄ main.tsx            # Entry point
‚îÇ   ‚îî‚îÄ‚îÄ index.css           # Estilos globais
‚îÇ
‚îú‚îÄ‚îÄ public/                 # Imagens, √≠cones
‚îú‚îÄ‚îÄ tailwind.config.ts      # Config Tailwind
‚îú‚îÄ‚îÄ vite.config.ts          # Config Vite
‚îî‚îÄ‚îÄ package.json            # Depend√™ncias frontend

‚ö†Ô∏è PODE LER, N√ÉO EDITAR:
‚îú‚îÄ‚îÄ src/integrations/supabase/
‚îÇ   ‚îú‚îÄ‚îÄ client.ts           # Cliente Supabase (gerado)
‚îÇ   ‚îî‚îÄ‚îÄ types.ts            # Tipos auto-gerados do banco

üö´ N√ÉO MEXER:
‚îî‚îÄ‚îÄ supabase/               # Pasta do backend
```

### üéØ Responsabilidades do Frontend

#### 1. **Interface de Usu√°rio (UI)**
- Criar/editar componentes visuais
- Estilizar com Tailwind CSS
- Garantir responsividade (mobile/desktop)
- Adicionar anima√ß√µes e transi√ß√µes

**Exemplo de tarefa:**
```
‚úÖ "Adicionar bot√£o de exportar an√°lise em PDF"
‚úÖ "Mudar cores do tema para azul"
‚úÖ "Criar modal de confirma√ß√£o ao deletar"
‚úÖ "Adicionar skeleton loading nas mensagens"
```

#### 2. **Experi√™ncia do Usu√°rio (UX)**
- Fluxos de navega√ß√£o
- Feedback visual (loading, success, error)
- Valida√ß√£o de formul√°rios
- Mensagens de erro amig√°veis

**Exemplo de tarefa:**
```
‚úÖ "Mostrar toast quando an√°lise for criada"
‚úÖ "Adicionar confirma√ß√£o antes de cancelar an√°lise"
‚úÖ "Melhorar feedback de upload de arquivo"
```

#### 3. **Consumo de Dados**
- Buscar dados do Supabase
- Escutar atualiza√ß√µes em tempo real
- Exibir dados na tela
- **N√ÉO criar l√≥gica de neg√≥cio**

**Exemplo de c√≥digo (OK para frontend):**
```typescript
// ‚úÖ BOM: Buscar e exibir dados
async function loadAnalysis(id: string) {
  const { data, error } = await supabase
    .from('analysis_requests')
    .select('*')
    .eq('id', id)
    .single()

  if (error) {
    toast.error('Erro ao carregar an√°lise')
    return
  }

  setAnalysis(data)
}

// ‚úÖ BOM: Escutar atualiza√ß√µes
useEffect(() => {
  const channel = supabase
    .channel(`analysis-${id}`)
    .on('postgres_changes', {
      event: 'UPDATE',
      schema: 'public',
      table: 'analysis_requests',
      filter: `id=eq.${id}`
    }, (payload) => {
      setAnalysis(payload.new)
    })
    .subscribe()

  return () => channel.unsubscribe()
}, [id])

// ‚ùå RUIM: L√≥gica de neg√≥cio no frontend
async function processAIResponse() {
  // Isso deveria estar no backend!
  const response = await openai.chat.completions.create(...)
  await sendWhatsAppMessage(...)
}
```

### üõ†Ô∏è Ferramentas do Frontend

#### Desenvolvimento Local
```bash
cd cliente-oculto-01
npm install
npm run dev  # http://localhost:5173
```

#### Comandos √öteis
```bash
npm run build     # Build de produ√ß√£o
npm run preview   # Testar build
npm run lint      # Verificar erros
```

#### Acessar Banco de Dados (Somente Leitura)
```typescript
// Buscar an√°lises
const { data } = await supabase
  .from('analysis_requests')
  .select('*')

// Buscar mensagens
const { data } = await supabase
  .from('messages')
  .select('*')
  .eq('analysis_id', id)
  .order('created_at', { ascending: true })
```

**IMPORTANTE:** Frontend NUNCA deve:
- ‚ùå Chamar APIs externas diretamente (Evolution, OpenAI)
- ‚ùå Processar l√≥gica de neg√≥cio complexa
- ‚ùå Manipular metadata cr√≠tico (follow-ups, timers)
- ‚ùå Enviar mensagens WhatsApp

---

## ‚öôÔ∏è Backend (L√≥gica do Servidor)

### üìÅ Arquivos de Responsabilidade

```
‚úÖ PODE EDITAR LIVREMENTE:
‚îî‚îÄ‚îÄ supabase/
    ‚îú‚îÄ‚îÄ functions/              # Edge Functions
    ‚îÇ   ‚îú‚îÄ‚îÄ handle-webhook/
    ‚îÇ   ‚îú‚îÄ‚îÄ monitor-conversations/
    ‚îÇ   ‚îî‚îÄ‚îÄ _shared/
    ‚îÇ       ‚îú‚îÄ‚îÄ evolutionApi.ts
    ‚îÇ       ‚îú‚îÄ‚îÄ openaiClient.ts
    ‚îÇ       ‚îî‚îÄ‚îÄ config/
    ‚îÇ
    ‚îú‚îÄ‚îÄ migrations/             # Estrutura do banco
    ‚îî‚îÄ‚îÄ seed.sql                # Dados de teste

‚ö†Ô∏è PODE LER, N√ÉO EDITAR:
‚îî‚îÄ‚îÄ src/integrations/supabase/
    ‚îî‚îÄ‚îÄ types.ts                # Tipos gerados (leia para saber estrutura)

üö´ N√ÉO MEXER:
‚îî‚îÄ‚îÄ src/                        # Pasta do frontend
```

### üéØ Responsabilidades do Backend

#### 1. **L√≥gica de Neg√≥cio**
- Processar conversas
- Gerar respostas IA
- Gerenciar follow-ups
- Calcular m√©tricas
- Definir quando conversa encerra

**Exemplo de tarefa:**
```
‚úÖ "Mudar delay de follow-up de 1h para 2h"
‚úÖ "Adicionar an√°lise de sentimento nas mensagens"
‚úÖ "Implementar retry em falhas de WhatsApp"
‚úÖ "Criar fun√ß√£o para exportar conversa em PDF"
```

#### 2. **Integra√ß√µes Externas**
- Enviar/receber mensagens WhatsApp (Evolution API)
- Gerar respostas IA (OpenAI)
- Salvar logs
- Webhooks

**Exemplo de tarefa:**
```
‚úÖ "Adicionar Perplexity AI para pesquisa"
‚úÖ "Implementar rate limiting no WhatsApp"
‚úÖ "Adicionar retry com backoff exponencial"
```

#### 3. **Banco de Dados**
- Criar/modificar tabelas (migrations)
- Definir √≠ndices para performance
- Configurar Row Level Security (RLS)
- Trigger functions

**Exemplo de tarefa:**
```
‚úÖ "Adicionar campo 'tags' na an√°lise"
‚úÖ "Criar √≠ndice para busca por telefone"
‚úÖ "Adicionar trigger para atualizar updated_at"
```

#### 4. **Seguran√ßa e Performance**
- Valida√ß√£o de dados
- Rate limiting
- Caching
- Otimiza√ß√£o de queries

**Exemplo de c√≥digo (OK para backend):**
```typescript
// ‚úÖ BOM: L√≥gica de neg√≥cio no backend
async function processUnreadMessages(analysisId: string) {
  // 1. Buscar mensagens n√£o processadas
  const { data: messages } = await supabase
    .from('messages')
    .select('*')
    .eq('analysis_id', analysisId)
    .eq('processed', false)
    .eq('role', 'user')
    .order('created_at', { ascending: true })

  if (!messages || messages.length === 0) return

  // 2. Gerar resposta IA
  const aiResponse = await generateAIResponse(messages)

  // 3. Enviar WhatsApp
  await sendWhatsAppMessage(analysis.evolution_instance, analysis.customer_phone, aiResponse)

  // 4. Salvar mensagem IA
  await supabase.from('messages').insert({
    analysis_id: analysisId,
    role: 'ai',
    content: aiResponse,
    processed: true
  })

  // 5. Marcar mensagens como processadas
  await supabase
    .from('messages')
    .update({ processed: true })
    .in('id', messages.map(m => m.id))

  // 6. Definir pr√≥ximo follow-up
  await defineNextFollowUp(analysisId)
}

// ‚ùå RUIM: Retornar HTML/JSX do backend
function generateReport(analysis: any) {
  return `<div><h1>${analysis.name}</h1></div>`  // Isso √© trabalho do frontend!
}
```

### üõ†Ô∏è Ferramentas do Backend

#### Desenvolvimento Local
```bash
# Instalar Supabase CLI
brew install supabase/tap/supabase

# Login
supabase login

# Vincular projeto
supabase link --project-ref ltjnbmvfjjphljcavrmp

# Rodar localmente (opcional)
supabase start  # Inicia Postgres + Functions local
```

#### Deploy
```bash
# Deploy function espec√≠fica
supabase functions deploy monitor-conversations

# Deploy todas
supabase functions deploy

# Aplicar migrations
supabase db push
```

#### Logs em Tempo Real
```bash
# Ver logs de fun√ß√£o espec√≠fica
supabase functions logs monitor-conversations --project-ref ltjnbmvfjjphljcavrmp

# Ver todos os logs
supabase functions logs --project-ref ltjnbmvfjjphljcavrmp
```

#### Testar Fun√ß√µes Localmente
```bash
# Invocar fun√ß√£o
supabase functions serve

# Em outro terminal
curl -X POST http://localhost:54321/functions/v1/monitor-conversations \
  -H "Authorization: Bearer YOUR_ANON_KEY"
```

---

## üîå Contrato de Interface (API)

Esta √© a **ponte** entre frontend e backend. Ambos devem concordar com esta estrutura.

### üìä Tabela: analysis_requests

```typescript
interface AnalysisRequest {
  id: string                      // UUID
  user_id: string                 // FK para auth.users
  customer_name: string           // Nome do cliente oculto
  customer_phone: string          // Telefone do vendedor
  objectives: string[]            // Objetivos da conversa
  analysis_depth: 'quick' | 'intermediate' | 'deep'
  evolution_instance: 'clienteoculto-homem' | 'clienteoculto-mulher'
  status: 'pending' | 'in_progress' | 'completed' | 'failed'
  next_ai_response_at: string | null  // ISO 8601 timestamp
  metadata: {
    next_ai_response_source?: 'webhook_planned' | 'ai_planned'
    next_follow_up_at?: string  // ISO 8601 timestamp
    follow_ups_sent?: number
    max_follow_ups?: number
    conversation_style?: 'casual' | 'balanced' | 'direct' | 'detailed'
    debug_logs?: Array<{
      timestamp: string
      level: 'info' | 'warning' | 'error' | 'success'
      message: string
      data?: any
    }>
  }
  analysis_result: {
    summary?: string
    sales_techniques?: string[]
    positive_points?: string[]
    improvement_areas?: string[]
    objective_completion?: Record<string, boolean>
    overall_score?: number
  } | null
  created_at: string              // ISO 8601 timestamp
  updated_at: string              // ISO 8601 timestamp
}
```

### üí¨ Tabela: messages

```typescript
interface Message {
  id: string                      // UUID
  analysis_id: string             // FK para analysis_requests
  role: 'user' | 'ai' | 'system'
  content: string
  processed: boolean              // Se j√° foi processada pelo backend
  whatsapp_message_id: string | null
  chunk_index: number | null      // Para mensagens quebradas
  created_at: string              // ISO 8601 timestamp
}
```

### üéØ Regras do Contrato

#### Frontend PODE:
- ‚úÖ Ler `analysis_requests` (somente suas an√°lises - RLS)
- ‚úÖ Ler `messages` (somente de suas an√°lises - RLS)
- ‚úÖ Criar `analysis_requests` (INSERT)
- ‚úÖ Atualizar `status` para 'cancelled' (se implementado)
- ‚úÖ Escutar mudan√ßas via Realtime

#### Frontend N√ÉO PODE:
- ‚ùå Criar `messages` (√© o backend que cria)
- ‚ùå Atualizar `next_ai_response_at` (l√≥gica do backend)
- ‚ùå Atualizar `metadata` (exceto se backend expor endpoint espec√≠fico)
- ‚ùå Atualizar `processed` (controle do backend)

#### Backend PODE:
- ‚úÖ Criar/atualizar qualquer registro (usa SERVICE_ROLE_KEY)
- ‚úÖ Ler qualquer registro
- ‚úÖ Deletar registros (se necess√°rio)

---

## üöÄ Workflows de Trabalho Paralelo

### Cen√°rio 1: Dev Frontend + Dev Backend

#### Dev Frontend:
1. Cria componente `ExportButton.tsx`
2. Adiciona bot√£o na tela de an√°lise
3. Ao clicar, chama: `POST /functions/v1/export-analysis`
4. Exibe loading enquanto processa
5. Baixa PDF quando retornar

#### Dev Backend (em paralelo):
1. Cria fun√ß√£o `export-analysis/index.ts`
2. Implementa gera√ß√£o de PDF com an√°lise
3. Deploy: `supabase functions deploy export-analysis`
4. Testa: `curl -X POST ...`

#### Integra√ß√£o:
- Frontend chama endpoint quando pronto
- Backend retorna PDF quando pronto
- Ambos trabalham independentemente at√© integrar

### Cen√°rio 2: M√∫ltiplos Agentes IA

#### Agente UI:
```
Tarefa: "Melhorar visual da tela de an√°lise"
Arquivos: src/pages/AnalysisDetails.tsx, src/components/
Restri√ß√£o: N√£o mexer em supabase/
```

#### Agente Backend:
```
Tarefa: "Implementar retry em falhas de WhatsApp"
Arquivos: supabase/functions/_shared/evolutionApi.ts
Restri√ß√£o: N√£o mexer em src/
```

#### Agente Banco:
```
Tarefa: "Adicionar campo 'tags' nas an√°lises"
Arquivos: supabase/migrations/
Depois: supabase db push
```

Todos podem trabalhar simultaneamente sem conflitos!

---

## üìã Checklist de Separa√ß√£o

### Para Frontend:

- [ ] C√≥digo est√° em `src/`
- [ ] Usa `supabase.from()` para ler dados
- [ ] N√£o faz chamadas diretas a APIs externas (Evolution, OpenAI)
- [ ] N√£o modifica `metadata` cr√≠tico
- [ ] Exibe dados de forma bonita e responsiva
- [ ] Trata erros com mensagens amig√°veis
- [ ] Testa em mobile e desktop

### Para Backend:

- [ ] C√≥digo est√° em `supabase/`
- [ ] Usa `SERVICE_ROLE_KEY` (acesso total)
- [ ] Valida dados de entrada
- [ ] Trata erros de APIs externas (retry, fallback)
- [ ] Salva logs para debug
- [ ] Atualiza `metadata` quando necess√°rio
- [ ] Testa localmente antes de deploy

### Para Banco de Dados:

- [ ] Mudan√ßas est√£o em migrations (n√£o manual)
- [ ] Migrations t√™m nome descritivo e timestamp
- [ ] Adicionou √≠ndices se necess√°rio
- [ ] RLS configurado corretamente
- [ ] Testou rollback (se der errado)
- [ ] Documentou schema no c√≥digo

---

## üîÑ Fluxo de Integra√ß√£o

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                    FRONTEND                                  ‚îÇ
‚îÇ                                                              ‚îÇ
‚îÇ  1. Usu√°rio clica em "Criar An√°lise"                        ‚îÇ
‚îÇ  2. Valida formul√°rio                                        ‚îÇ
‚îÇ  3. POST /analysis_requests                                  ‚îÇ
‚îÇ  4. Exibe loading...                                         ‚îÇ
‚îÇ  5. Escuta Realtime para atualiza√ß√µes                        ‚îÇ
‚îÇ  6. Exibe mensagens conforme chegam                          ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                     ‚îÇ
                     ‚îÇ Supabase (Banco + Realtime)
                     ‚îÇ
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                    BACKEND                                   ‚îÇ
‚îÇ                                                              ‚îÇ
‚îÇ  1. Cron job dispara monitor-conversations a cada 30s       ‚îÇ
‚îÇ  2. Busca an√°lises 'in_progress'                            ‚îÇ
‚îÇ  3. Verifica janela de agrupamento                          ‚îÇ
‚îÇ  4. Processa mensagens novas                                ‚îÇ
‚îÇ  5. Gera resposta IA (OpenAI)                               ‚îÇ
‚îÇ  6. Envia WhatsApp (Evolution API)                          ‚îÇ
‚îÇ  7. Salva no banco                                          ‚îÇ
‚îÇ  8. Frontend recebe via Realtime automaticamente            ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

**Comunica√ß√£o:**
- Frontend ‚Üí Backend: Via tabelas Supabase (INSERT/UPDATE)
- Backend ‚Üí Frontend: Via Supabase Realtime (notifica√ß√µes autom√°ticas)
- **Nunca** chamadas HTTP diretas entre frontend e backend

---

## üéØ Exemplos Pr√°ticos de Separa√ß√£o

### Exemplo 1: Adicionar Campo "Tags"

#### Backend (Dev 1):
```sql
-- supabase/migrations/20250126_add_tags.sql
ALTER TABLE analysis_requests
ADD COLUMN tags TEXT[] DEFAULT '{}';
```
```bash
supabase db push
```

#### Frontend (Dev 2 - em paralelo):
```typescript
// src/pages/Index.tsx
<input
  type="text"
  placeholder="Tags (separadas por v√≠rgula)"
  value={tags}
  onChange={(e) => setTags(e.target.value)}
/>

// Ao criar an√°lise
await supabase.from('analysis_requests').insert({
  ...outros_campos,
  tags: tags.split(',').map(t => t.trim())
})
```

**Integra√ß√£o:** Ap√≥s backend fazer push, frontend j√° pode usar o campo!

### Exemplo 2: Implementar Exportar PDF

#### Backend (Dev 1):
```typescript
// supabase/functions/export-analysis/index.ts
import { PDFDocument } from 'pdf-lib'

Deno.serve(async (req) => {
  const { analysisId } = await req.json()

  // Buscar an√°lise + mensagens
  const { data: analysis } = await supabase
    .from('analysis_requests')
    .select('*, messages(*)')
    .eq('id', analysisId)
    .single()

  // Gerar PDF
  const pdfDoc = await PDFDocument.create()
  // ... adicionar conte√∫do

  const pdfBytes = await pdfDoc.save()

  return new Response(pdfBytes, {
    headers: {
      'Content-Type': 'application/pdf',
      'Content-Disposition': `attachment; filename="analise-${analysisId}.pdf"`
    }
  })
})
```

#### Frontend (Dev 2 - em paralelo):
```typescript
// src/components/ExportButton.tsx
async function handleExport() {
  setLoading(true)
  try {
    const response = await fetch(
      `${SUPABASE_URL}/functions/v1/export-analysis`,
      {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ analysisId: id })
      }
    )

    const blob = await response.blob()
    const url = URL.createObjectURL(blob)
    const a = document.createElement('a')
    a.href = url
    a.download = `analise-${id}.pdf`
    a.click()
    toast.success('PDF exportado com sucesso!')
  } catch (error) {
    toast.error('Erro ao exportar PDF')
  } finally {
    setLoading(false)
  }
}
```

**Integra√ß√£o:** Frontend testa com mock enquanto backend desenvolve. Depois conecta!

---

## üõ°Ô∏è Regras de Seguran√ßa

### Frontend (.env.local)
```bash
# Chave ANON (p√∫blica, pode ir no c√≥digo)
VITE_SUPABASE_ANON_KEY=eyJhbGc...
```
- ‚úÖ Pode ser compartilhada
- ‚úÖ Limitada por RLS
- ‚úÖ Somente l√™ dados do pr√≥prio usu√°rio

### Backend (Supabase Secrets)
```bash
# Chave SERVICE_ROLE (NUNCA expor!)
SUPABASE_SERVICE_ROLE_KEY=eyJhbGc...
OPENAI_API_KEY=sk-proj-...
EVOLUTION_API_KEY=429683...
```
- ‚ùå NUNCA colocar no frontend
- ‚ùå NUNCA commitar no Git
- ‚úÖ Acesso total ao banco
- ‚úÖ Pode chamar APIs externas

---

## üìö Resumo em 3 Regras Simples

### 1. Frontend = Visual
- Componentes bonitos
- Exibir dados
- Navega√ß√£o e UX
- **N√£o processa l√≥gica de neg√≥cio**

### 2. Backend = L√≥gica
- Processamento de dados
- Integra√ß√µes com APIs
- Regras de neg√≥cio
- **N√£o gera HTML/componentes**

### 3. Contrato = Banco de Dados
- Frontend l√™/escreve nas tabelas acordadas
- Backend gerencia tudo
- Realtime conecta os dois
- **Ambos respeitam o schema**

---

## üéì Para Iniciantes

**"Eu quero mexer na cor do bot√£o"**
‚Üí Frontend! Arquivo: `src/components/`

**"Eu quero mudar o tempo de follow-up"**
‚Üí Backend! Arquivo: `supabase/functions/monitor-conversations/index.ts`

**"Eu quero adicionar um campo novo"**
‚Üí Banco! Arquivo: `supabase/migrations/`

**"Eu quero mudar o texto da mensagem de boas-vindas"**
‚Üí Backend! Arquivo: `supabase/functions/_shared/config/prompts.ts`

**"Eu quero mudar o layout do chat"**
‚Üí Frontend! Arquivo: `src/pages/AnalysisDetails.tsx`

---

## üöÄ Checklist para Come√ßar a Trabalhar

### Frontend Developer:
- [ ] Clone o reposit√≥rio
- [ ] `npm install`
- [ ] Configure `.env.local` com SUPABASE_URL e ANON_KEY
- [ ] `npm run dev`
- [ ] Abra `http://localhost:5173`
- [ ] Edite arquivos em `src/`

### Backend Developer:
- [ ] Clone o reposit√≥rio
- [ ] `brew install supabase/tap/supabase`
- [ ] `supabase login`
- [ ] `supabase link --project-ref ltjnbmvfjjphljcavrmp`
- [ ] Configure secrets no Supabase Dashboard
- [ ] Edite arquivos em `supabase/`
- [ ] Deploy: `supabase functions deploy`

### Database Developer:
- [ ] Mesmo setup do Backend
- [ ] Crie migration: `supabase migration new nome_da_migration`
- [ ] Edite arquivo SQL em `supabase/migrations/`
- [ ] Aplique: `supabase db push`
- [ ] Verifique no Supabase Dashboard

---

Agora voc√™ pode dividir o trabalho e m√∫ltiplas pessoas/agentes podem trabalhar no projeto simultaneamente! üéâ
